extern crate hydra_cli;

use clap::{App, Arg, SubCommand};
use std::str::FromStr;
use std::time::Duration;

use hydra_cli::hydra::example::jobset_config;
use hydra_cli::hydra::reqwest_client::Client as ReqwestHydraClient;
use hydra_cli::ops::{
    eval_wait, jobset_create, jobset_eval, jobset_wait, project, project_create, project_list,
    reproduce, search, OpError, OpResult,
};

fn main() {
    let config_after_help = &format!(
        "Here is an example JSON config:\n\n{}",
        serde_json::to_string_pretty(&jobset_config()).unwrap()
    )[..];
    let app = App::new("hydra-cli")
        .version("0.2.0")
        .about("CLI Hydra client")
        .author("lewo")
        .after_help("A client to query Hydra through its JSON API.")
        .arg(
            Arg::with_name("host")
                .short("H")
                .long("host")
                .default_value("https://hydra.nixos.org")
                .env("HYDRA_HOST")
                .help("Hydra host URL"),
        )
        .arg(
            Arg::with_name("no-check-certificate")
                .long("no-check-certificate")
                .help("Disable TLS certificate check for the Hydra host"),
        )
        .subcommand(
            SubCommand::with_name("search")
                .about("Search by output paths")
                .arg(
                    Arg::with_name("query")
                        .required(true)
                        .help("Piece of an output path (hash, name,...)"),
                )
                .arg(
                    Arg::with_name("limit")
                        .default_value("10")
                        .help("How many results to return"),
                ),
        )
        .subcommand(
            SubCommand::with_name("reproduce")
                .about("Retrieve information to reproduce an output path")
                .arg(
                    Arg::with_name("query")
                        .required(true)
                        .help("Piece of an output path (hash, name,...)"),
                )
                .arg(Arg::with_name("json").short("j").help("JSON output")),
        )
        .subcommand(
            SubCommand::with_name("project-list")
                .about("List projects")
                .arg(Arg::with_name("json").short("j").help("JSON output")),
        )
        .subcommand(
            SubCommand::with_name("project-show")
                .about("Get information of a project")
                .arg(
                    Arg::with_name("project")
                        .required(true)
                        .help("A project name"),
                )
                .arg(Arg::with_name("json").short("j").help("JSON output")),
        )
        .subcommand(
            SubCommand::with_name("project-create")
                .about("Create a new project")
                .arg(
                    Arg::with_name("project")
                        .required(true)
                        .help("The name of the project in which to create the jobset"),
                )
                .arg(
                    Arg::with_name("user")
                        .takes_value(true)
                        .required(true)
                        .long("user")
                        .env("HYDRA_USER")
                        .help("A user name"),
                )
                .arg(
                    Arg::with_name("password")
                        .takes_value(true)
                        .required(true)
                        .long("password")
                        .env("HYDRA_PASSWORD")
                        .help("A user password"),
                ),
        )
        .subcommand(
            SubCommand::with_name("jobset-create")
                .about("Add a jobset to a project")
                .arg(
                    Arg::with_name("project")
                        .required(true)
                        .help("The project to add the jobset to"),
                )
                .arg(
                    Arg::with_name("jobset")
                        .required(true)
                        .help("The name of the jobset to create"),
                )
                .arg(
                    Arg::with_name("config")
                        .required(true)
                        .help("Project configuration JSON filepath"),
                )
                .arg(
                    Arg::with_name("user")
                        .takes_value(true)
                        .required(true)
                        .long("user")
                        .env("HYDRA_USER")
                        .help("A user name"),
                )
                .arg(
                    Arg::with_name("password")
                        .takes_value(true)
                        .required(true)
                        .long("password")
                        .env("HYDRA_PASSWORD")
                        .help("A user password"),
                )
                .after_help(config_after_help),
        )
        .subcommand(
            SubCommand::with_name("jobset-eval")
                .about("Evaluate a jobset")
                .arg(
                    Arg::with_name("project")
                        .required(true)
                        .help("The project to evaluate the jobset from"),
                )
                .arg(
                    Arg::with_name("jobset")
                        .required(true)
                        .help("The jobset to evaluate"),
                ),
        )
        .subcommand(
            SubCommand::with_name("eval-wait")
                .about("Wait for eval completion")
                .arg(
                    Arg::with_name("eval-id")
                        .required(true)
                        .help("The project of the jobset to wait for"),
                ),
        )
        .subcommand(
            SubCommand::with_name("jobset-wait")
                .about("Wait for jobset completion")
                .arg(
                    Arg::with_name("project")
                        .required(true)
                        .help("The project of the jobset to wait for"),
                )
                .arg(
                    Arg::with_name("jobset")
                        .required(true)
                        .help("The name of the jobset to wait for"),
                )
                .arg(
                    Arg::with_name("timeout")
                        .long("timeout")
                        .takes_value(true)
                        .help("Maximum time to wait for (in seconds)"),
                ),
        );

    let mut help_buffer = Vec::new();
    app.write_help(&mut help_buffer).unwrap();
    let help_string = String::from_utf8(help_buffer).unwrap();

    let matches = app.get_matches();
    let host = matches.value_of("host").unwrap();
    let no_check_certs = matches.is_present("no-check-certificate");
    let c = reqwest::blocking::Client::builder()
        .cookie_store(true)
        .danger_accept_invalid_certs(no_check_certs)
        .build()
        .unwrap();
    let client = ReqwestHydraClient::new(c, String::from(host));

    let cmd_res: OpResult = match matches.subcommand() {
        ("search", Some(args)) => search::run(
            &client,
            args.value_of("query").unwrap(),
            args.value_of("limit").unwrap().parse().unwrap(),
        ),

        ("reproduce", Some(args)) => reproduce::run(
            &client,
            host,
            args.value_of("query").unwrap(),
            args.is_present("json"),
        ),

        ("project-list", Some(args)) => project_list::run(&client, args.is_present("json")),

        ("project-show", Some(args)) => project::run(
            &client,
            args.value_of("project").unwrap(),
            args.is_present("json"),
        ),

        ("project-create", Some(args)) => project_create::run(
            &client,
            args.value_of("project").unwrap(),
            args.value_of("user").unwrap(),
            args.value_of("password").unwrap(),
        ),

        ("jobset-create", Some(args)) => jobset_create::run(
            &client,
            args.value_of("config").unwrap(),
            args.value_of("project").unwrap(),
            args.value_of("jobset").unwrap(),
            args.value_of("user").unwrap(),
            args.value_of("password").unwrap(),
        ),

        ("jobset-eval", Some(args)) => jobset_eval::run(
            &client,
            args.value_of("project").unwrap(),
            args.value_of("jobset").unwrap(),
        ),

        ("jobset-wait", Some(args)) => jobset_wait::run(
            &client,
            args.value_of("project").unwrap(),
            args.value_of("jobset").unwrap(),
            args.value_of("timeout")
                .map(|t| Duration::from_secs(u64::from_str(t).unwrap())),
        ),

        ("eval-wait", Some(args)) => eval_wait::run(
            &client,
            u64::from_str(args.value_of("eval-id").unwrap()).unwrap(),
        ),

        _ => {
            println!("{}", help_string);
            Err(OpError::CmdErr)
        }
    };

    match cmd_res {
        Ok(_) => std::process::exit(0),
        Err(OpError::AuthError) => {
            eprintln!("ERROR: Failed to login. Please check your credentials");
            std::process::exit(1)
        }
        Err(OpError::CmdErr) => {
            eprintln!("ERROR: hydra-cli called with invalid arguments");
            std::process::exit(1)
        }
        Err(OpError::RequestError(m)) => {
            eprintln!("ERROR: {}", m);
            std::process::exit(1)
        }
        Err(OpError::TimeoutError) => {
            eprintln!("ERROR: Timeout");
            std::process::exit(124)
        }
        Err(OpError::Error(m)) => {
            eprintln!("ERROR: {}", m);
            std::process::exit(1)
        }
    }
}
